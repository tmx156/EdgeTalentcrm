{
  "permissions": {
    "allow": [
      "Bash(node:*)",
      "Bash(cat:*)",
      "Bash(curl -s http://localhost:3001/api/leads/public?limit=100)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(curl:*)",
      "Bash(taskkill:*)",
      "Bash(git push:*)",
      "Bash(netstat:*)",
      "Bash(findstr:*)",
      "Bash(npm start)",
      "Bash(timeout 15 node:*)",
      "Bash(timeout:*)",
      "Bash(tasklist)",
      "Bash(dir /b *.js)",
      "Bash(echo:*)",
      "Bash(railway login --help:*)",
      "Bash(set \"RAILWAY_TOKEN=f6e95579-3313-45af-b0e6-c0249690ad9a\")",
      "Bash(railway logs --help:*)",
      "Bash(set RAILWAY_TOKEN=f6e95579-3313-45af-b0e6-c0249690ad9a)",
      "Bash(railway whoami:*)",
      "Bash(powershell -Command \"$env:RAILWAY_TOKEN=''f6e95579-3313-45af-b0e6-c0249690ad9a''; railway whoami\")",
      "Bash(cmd /c \"set RAILWAY_TOKEN=f6e95579-3313-45af-b0e6-c0249690ad9a && railway whoami\")",
      "Bash(dir \"C:\\Users\\Tin\\CRM -Alan\\server\" /b)",
      "Bash(find:*)",
      "Bash(npm install:*)",
      "Bash(npm run build:*)",
      "Bash(ping:*)",
      "Bash(dir:*)",
      "Bash(cmd /c \"taskkill /F /IM node.exe\")",
      "Bash(powershell -Command \"Stop-Process -Name node -Force\")",
      "Bash(railway login:*)",
      "Bash(railway status:*)",
      "Bash(cmd /c \"set RAILWAY_TOKEN=f6e95579-3313-45af-b0e6-c0249690ad9a&& railway logs --limit 50\")",
      "Bash(set CI=false)",
      "Bash(set GENERATE_SOURCEMAP=false)",
      "Bash(git revert:*)",
      "Bash(npx react-scripts build)",
      "Bash(powershell:*)",
      "Bash(cmd /c \"set CI=false && set GENERATE_SOURCEMAP=false && npm run build\")",
      "Bash(railway up:*)",
      "Bash(del \"c:\\Users\\Tin\\CRM -Alan\\server\\verify_blocks.js\")",
      "Bash(cmd /c \"set RAILWAY_TOKEN=f6e95579-3313-45af-b0e6-c0249690ad9a&& railway logs --limit 100\")",
      "Bash(del \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\check_image_types.js\")",
      "Bash(if exist \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\check_image_types.js\" del \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\check_image_types.js\")",
      "Bash(cmd /c \"del \"\"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\check_image_types.js\"\" 2>nul\")",
      "WebSearch",
      "Bash(ls -la \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\client\\\\src\\\\pages\"\" | findstr /i \"photo \")",
      "Bash(node -e:*)",
      "Bash(set \"CI=false\")",
      "Bash(npm uninstall:*)",
      "Bash(copy \"c:\\\\Users\\\\Tin\\\\Downloads\\\\EDGE TALENT INVOICE Terms and conditions \\(1\\).pdf\" \"c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\\\\contract-template.pdf\")",
      "Bash(cmd /c \"mkdir \"\"c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\"\" 2>nul & copy \"\"c:\\\\Users\\\\Tin\\\\Downloads\\\\EDGE TALENT INVOICE Terms and conditions \\(1\\).pdf\"\" \"\"c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\\\\contract-template.pdf\"\"\")",
      "Bash(cmd /c \"dir \"\"c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\"\"\")",
      "Bash(powershell -Command \"New-Item -ItemType Directory -Force -Path ''C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates''; Copy-Item ''C:\\\\Users\\\\Tin\\\\Downloads\\\\EDGE TALENT INVOICE Terms and conditions \\(1\\).pdf'' -Destination ''C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\\\\contract-template.pdf''\")",
      "Bash(powershell -Command:*)",
      "Bash(dir \"c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\")",
      "Bash(set \"GENERATE_SOURCEMAP=false\")",
      "Bash(tasklist:*)",
      "Bash(timeout /t 5 /nobreak)",
      "Bash(taskkill /F /PID 47132)",
      "Bash(taskkill //F //PID 47132)",
      "Bash(wmic process where \"ProcessId=33060\" get CommandLine:*)",
      "Bash(while read pid)",
      "Bash(do taskkill //F //PID $pid)",
      "Bash(done)",
      "Bash(git checkout:*)",
      "Bash(npm install)",
      "Bash(powershell -Command \"\\(Get-Item ''c:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\templates\\\\EDGE TALENT INVOICE Terms and conditions \\(1\\).pdf''\\).Length\")",
      "Bash(git push)",
      "Bash(git reset:*)",
      "Bash(git restore:*)",
      "Bash(cmd //c \"taskkill /PID 19936 /F\")",
      "Bash(npx eslint:*)",
      "Bash(del \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\delete-test-leads.js\")",
      "Bash(grep:*)",
      "Bash(set \"NODE_PATH=C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\node_modules\")",
      "Bash(copy:*)",
      "Bash(move \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\Leads_Upload_Template.xlsx\" \"C:\\\\Users\\\\Tin\\\\Desktop\\\\Leads_Upload_Template.xlsx\")",
      "Bash(gh repo view:*)",
      "Bash(ls:*)",
      "Bash(python3 -c \"\nimport base64\nscript = open\\(''/dev/stdin'',''r''\\).read\\(\\) if False else ''''\n\")",
      "Bash(python3:*)",
      "Bash(printf:*)",
      "Bash(python -c:*)",
      "mcp__ide__getDiagnostics",
      "Bash(del \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\_query_leads_temp.js\")",
      "Bash(\"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\fix_booker_overwrite.js\" << 'ENDOFSCRIPT'\n/**\n * Fix booker_id overwrites caused by reschedule/confirmation bug.\n * \n * 1. Fix Sophie Hume's booker_id back to Amy Booker\n * 2. Find all other leads where booker_id was overwritten\n * 3. Report and fix mismatches\n */\n\nrequire\\('dotenv'\\).config\\(\\);\nconst { Pool } = require\\('pg'\\);\n\nconst pool = new Pool\\({\n  connectionString: process.env.DATABASE_URL,\n  ssl: { rejectUnauthorized: false }\n}\\);\n\nasync function run\\(\\) {\n  const client = await pool.connect\\(\\);\n  \n  try {\n    // ============================================================\n    // STEP 1: Fix Sophie Hume's booker_id back to Amy Booker\n    // ============================================================\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('STEP 1: Fix Sophie Hume \\(lead 8e465a93-4f22-4878-aab8-fd2615dfe2ff\\)'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n    const sophieLeadId = '8e465a93-4f22-4878-aab8-fd2615dfe2ff';\n    const amyBookerId = 'f038e141-203b-4d37-b641-88ac9bd58627';\n    \n    // First check current state\n    const sophieBefore = await client.query\\(\n      `SELECT l.id, l.name, l.email, l.booker_id, l.booking_history, u.name as current_booker_name\n       FROM leads l\n       LEFT JOIN users u ON l.booker_id = u.id\n       WHERE l.id = $1`,\n      [sophieLeadId]\n    \\);\n    \n    if \\(sophieBefore.rows.length === 0\\) {\n      console.log\\('WARNING: Sophie Hume lead not found!'\\);\n    } else {\n      const sophie = sophieBefore.rows[0];\n      console.log\\('\\\\n  Lead: ' + sophie.name + ' \\(' + sophie.email + '\\)'\\);\n      console.log\\('  Current booker_id: ' + sophie.booker_id\\);\n      console.log\\('  Current booker name: ' + sophie.current_booker_name\\);\n      \n      // Fix it\n      await client.query\\(\n        'UPDATE leads SET booker_id = $1 WHERE id = $2',\n        [amyBookerId, sophieLeadId]\n      \\);\n      \n      // Verify\n      const sophieAfter = await client.query\\(\n        `SELECT l.booker_id, u.name as booker_name\n         FROM leads l\n         LEFT JOIN users u ON l.booker_id = u.id\n         WHERE l.id = $1`,\n        [sophieLeadId]\n      \\);\n      console.log\\('  FIXED -> booker_id now: ' + sophieAfter.rows[0].booker_id\\);\n      console.log\\('  FIXED -> booker name: ' + sophieAfter.rows[0].booker_name\\);\n    }\n    \n    // ============================================================\n    // STEP 2: Find ALL leads with booker_id mismatches\n    // ============================================================\n    console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n    console.log\\('STEP 2: Scanning ALL Booked leads for booker_id overwrites'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n    // Get all users for lookups\n    const usersResult = await client.query\\('SELECT id, name, email FROM users'\\);\n    const usersMap = {};\n    for \\(const u of usersResult.rows\\) {\n      usersMap[u.id] = u;\n    }\n    \n    // Get all booked leads with booking_history\n    const leadsResult = await client.query\\(\n      `SELECT l.id, l.name, l.email, l.phone, l.booker_id, l.booking_history, l.status,\n              u.name as current_booker_name\n       FROM leads l\n       LEFT JOIN users u ON l.booker_id = u.id\n       WHERE l.status = 'Booked'\n         AND l.booking_history IS NOT NULL\n         AND l.booker_id IS NOT NULL\n       ORDER BY l.name`\n    \\);\n    \n    console.log\\('\\\\nFound ' + leadsResult.rows.length + ' Booked leads with booking_history to check.\\\\n'\\);\n    \n    const mismatches = [];\n    let checkedCount = 0;\n    \n    for \\(const lead of leadsResult.rows\\) {\n      checkedCount++;\n      let history;\n      \n      try {\n        if \\(typeof lead.booking_history === 'string'\\) {\n          history = JSON.parse\\(lead.booking_history\\);\n        } else {\n          history = lead.booking_history;\n        }\n      } catch \\(e\\) {\n        console.log\\('  [SKIP] Could not parse booking_history for ' + lead.name + ' \\(' + lead.id + '\\): ' + e.message\\);\n        continue;\n      }\n      \n      if \\(!Array.isArray\\(history\\) || history.length === 0\\) continue;\n      \n      // Find the earliest EMAIL_SENT or booking-related entry with a user_id\n      let originalBooker = null;\n      let originalEntry = null;\n      \n      for \\(const entry of history\\) {\n        const action = \\(entry.action || entry.type || ''\\).toUpperCase\\(\\);\n        const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n        \n        if \\(userId && \\(\n          action.includes\\('EMAIL'\\) ||\n          action.includes\\('BOOK'\\) ||\n          action.includes\\('CONFIRM'\\) ||\n          action.includes\\('ASSIGN'\\) ||\n          action.includes\\('STATUS_CHANGE'\\)\n        \\)\\) {\n          if \\(!originalBooker\\) {\n            originalBooker = userId;\n            originalEntry = entry;\n          }\n          break;\n        }\n      }\n      \n      // Fallback: check the very first entry with any user_id\n      if \\(!originalBooker\\) {\n        for \\(const entry of history\\) {\n          const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          if \\(userId\\) {\n            originalBooker = userId;\n            originalEntry = entry;\n            break;\n          }\n        }\n      }\n      \n      if \\(!originalBooker\\) continue;\n      \n      // Compare\n      if \\(originalBooker !== lead.booker_id\\) {\n        const originalUser = usersMap[originalBooker] || { name: 'UNKNOWN', email: 'unknown' };\n        \n        mismatches.push\\({\n          leadId: lead.id,\n          leadName: lead.name,\n          leadEmail: lead.email,\n          currentBookerId: lead.booker_id,\n          currentBookerName: lead.current_booker_name || 'UNKNOWN',\n          originalBookerId: originalBooker,\n          originalBookerName: originalUser.name || 'UNKNOWN',\n          firstHistoryEntry: originalEntry,\n          historyLength: history.length,\n          allHistory: history\n        }\\);\n      }\n    }\n    \n    // ============================================================\n    // STEP 3: Print detailed report\n    // ============================================================\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('STEP 3: MISMATCH REPORT'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('\\\\nChecked ' + checkedCount + ' Booked leads.'\\);\n    console.log\\('Found ' + mismatches.length + ' leads with booker_id mismatches.\\\\n'\\);\n    \n    if \\(mismatches.length === 0\\) {\n      console.log\\('No mismatches found \\(besides Sophie Hume which was already fixed above\\).'\\);\n    } else {\n      for \\(let i = 0; i < mismatches.length; i++\\) {\n        const m = mismatches[i];\n        console.log\\('-'.repeat\\(70\\)\\);\n        console.log\\('MISMATCH #' + \\(i + 1\\) + ':'\\);\n        console.log\\('  Lead Name:        ' + m.leadName\\);\n        console.log\\('  Lead Email:       ' + m.leadEmail\\);\n        console.log\\('  Lead ID:          ' + m.leadId\\);\n        console.log\\('  Current Booker:   ' + m.currentBookerName + ' \\(' + m.currentBookerId + '\\)'\\);\n        console.log\\('  Original Booker:  ' + m.originalBookerName + ' \\(' + m.originalBookerId + '\\)'\\);\n        console.log\\('  History Entries:   ' + m.historyLength\\);\n        console.log\\('  First Entry:      ' + JSON.stringify\\(m.firstHistoryEntry\\)\\);\n        \n        // Show all history entries with user IDs for context\n        console.log\\('  Full booking_history user trail:'\\);\n        for \\(const entry of m.allHistory\\) {\n          const uid = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          const action = entry.action || entry.type || 'N/A';\n          const timestamp = entry.timestamp || entry.date || entry.created_at || 'N/A';\n          const userName = uid ? \\(\\(usersMap[uid] && usersMap[uid].name\\) || 'UNKNOWN'\\) : 'no-user';\n          if \\(uid\\) {\n            console.log\\('    -> [' + timestamp + '] ' + action + ' by ' + userName + ' \\(' + uid + '\\)'\\);\n          }\n        }\n        console.log\\('  SHOULD FIX: YES - restore booker_id to ' + m.originalBookerName\\);\n      }\n    }\n    \n    // ============================================================\n    // STEP 4: Fix the mismatches\n    // ============================================================\n    if \\(mismatches.length > 0\\) {\n      console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n      console.log\\('STEP 4: FIXING MISMATCHES'\\);\n      console.log\\('='.repeat\\(80\\)\\);\n      \n      let fixCount = 0;\n      for \\(const m of mismatches\\) {\n        // Skip Sophie Hume - already fixed in step 1\n        if \\(m.leadId === sophieLeadId\\) {\n          console.log\\('\\\\n  [SKIP] ' + m.leadName + ' - already fixed in Step 1'\\);\n          continue;\n        }\n        \n        console.log\\('\\\\n  Fixing ' + m.leadName + ' \\(' + m.leadId + '\\)...'\\);\n        console.log\\('    ' + m.currentBookerName + ' -> ' + m.originalBookerName\\);\n        \n        await client.query\\(\n          'UPDATE leads SET booker_id = $1 WHERE id = $2',\n          [m.originalBookerId, m.leadId]\n        \\);\n        \n        fixCount++;\n        console.log\\('    DONE'\\);\n      }\n      \n      console.log\\('\\\\n  Fixed ' + fixCount + ' additional leads.'\\);\n    }\n    \n    // Final summary\n    console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n    console.log\\('SUMMARY'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('  Sophie Hume: FIXED \\(booker restored to Amy Booker\\)'\\);\n    console.log\\('  Other mismatches found: ' + mismatches.length\\);\n    console.log\\('  Total leads checked: ' + checkedCount\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n  } catch \\(err\\) {\n    console.error\\('ERROR:', err\\);\n  } finally {\n    client.release\\(\\);\n    await pool.end\\(\\);\n  }\n}\n\nrun\\(\\);\nENDOFSCRIPT)",
      "Bash(powershell.exe -File - << 'PSEOF'\n$script = @\"\nrequire\\('dotenv'\\).config\\(\\);\nconst { Pool } = require\\('pg'\\);\n\nconst pool = new Pool\\({\n  connectionString: process.env.DATABASE_URL,\n  ssl: { rejectUnauthorized: false }\n}\\);\n\nasync function run\\(\\) {\n  const client = await pool.connect\\(\\);\n  try {\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('STEP 1: Fix Sophie Hume'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n    const sophieLeadId = '8e465a93-4f22-4878-aab8-fd2615dfe2ff';\n    const amyBookerId = 'f038e141-203b-4d37-b641-88ac9bd58627';\n    \n    const sophieBefore = await client.query\\(\n      'SELECT l.id, l.name, l.email, l.booker_id, u.name as current_booker_name FROM leads l LEFT JOIN users u ON l.booker_id = u.id WHERE l.id = `$1',\n      [sophieLeadId]\n    \\);\n    \n    if \\(sophieBefore.rows.length === 0\\) {\n      console.log\\('WARNING: Sophie Hume lead not found!'\\);\n    } else {\n      const sophie = sophieBefore.rows[0];\n      console.log\\('  Lead: ' + sophie.name + ' \\(' + sophie.email + '\\)'\\);\n      console.log\\('  Current booker_id: ' + sophie.booker_id\\);\n      console.log\\('  Current booker name: ' + sophie.current_booker_name\\);\n      \n      await client.query\\('UPDATE leads SET booker_id = `$1 WHERE id = `$2', [amyBookerId, sophieLeadId]\\);\n      \n      const sophieAfter = await client.query\\(\n        'SELECT l.booker_id, u.name as booker_name FROM leads l LEFT JOIN users u ON l.booker_id = u.id WHERE l.id = `$1',\n        [sophieLeadId]\n      \\);\n      console.log\\('  FIXED -> booker_id now: ' + sophieAfter.rows[0].booker_id\\);\n      console.log\\('  FIXED -> booker name: ' + sophieAfter.rows[0].booker_name\\);\n    }\n    \n    console.log\\(''\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('STEP 2: Scanning ALL Booked leads for booker_id overwrites'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n    const usersResult = await client.query\\('SELECT id, name, email FROM users'\\);\n    const usersMap = {};\n    for \\(const u of usersResult.rows\\) { usersMap[u.id] = u; }\n    \n    const leadsResult = await client.query\\(\n      \"SELECT l.id, l.name, l.email, l.phone, l.booker_id, l.booking_history, l.status, u.name as current_booker_name FROM leads l LEFT JOIN users u ON l.booker_id = u.id WHERE l.status = 'Booked' AND l.booking_history IS NOT NULL AND l.booker_id IS NOT NULL ORDER BY l.name\"\n    \\);\n    \n    console.log\\('Found ' + leadsResult.rows.length + ' Booked leads with booking_history to check.'\\);\n    \n    const mismatches = [];\n    let checkedCount = 0;\n    \n    for \\(const lead of leadsResult.rows\\) {\n      checkedCount++;\n      let history;\n      try {\n        history = typeof lead.booking_history === 'string' ? JSON.parse\\(lead.booking_history\\) : lead.booking_history;\n      } catch \\(e\\) { continue; }\n      if \\(!Array.isArray\\(history\\) || history.length === 0\\) continue;\n      \n      let originalBooker = null;\n      let originalEntry = null;\n      \n      for \\(const entry of history\\) {\n        const action = \\(entry.action || entry.type || ''\\).toUpperCase\\(\\);\n        const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n        if \\(userId && \\(action.includes\\('EMAIL'\\) || action.includes\\('BOOK'\\) || action.includes\\('CONFIRM'\\) || action.includes\\('ASSIGN'\\) || action.includes\\('STATUS'\\)\\)\\) {\n          originalBooker = userId;\n          originalEntry = entry;\n          break;\n        }\n      }\n      \n      if \\(!originalBooker\\) {\n        for \\(const entry of history\\) {\n          const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          if \\(userId\\) { originalBooker = userId; originalEntry = entry; break; }\n        }\n      }\n      \n      if \\(!originalBooker\\) continue;\n      \n      if \\(originalBooker !== lead.booker_id\\) {\n        const originalUser = usersMap[originalBooker] || { name: 'UNKNOWN', email: 'unknown' };\n        mismatches.push\\({\n          leadId: lead.id, leadName: lead.name, leadEmail: lead.email,\n          currentBookerId: lead.booker_id, currentBookerName: lead.current_booker_name || 'UNKNOWN',\n          originalBookerId: originalBooker, originalBookerName: originalUser.name || 'UNKNOWN',\n          firstHistoryEntry: originalEntry, historyLength: history.length, allHistory: history\n        }\\);\n      }\n    }\n    \n    console.log\\(''\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('STEP 3: MISMATCH REPORT'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('Checked ' + checkedCount + ' Booked leads.'\\);\n    console.log\\('Found ' + mismatches.length + ' leads with booker_id mismatches.'\\);\n    console.log\\(''\\);\n    \n    if \\(mismatches.length === 0\\) {\n      console.log\\('No mismatches found besides Sophie Hume \\(already fixed\\).'\\);\n    } else {\n      for \\(let i = 0; i < mismatches.length; i++\\) {\n        const m = mismatches[i];\n        console.log\\('-'.repeat\\(70\\)\\);\n        console.log\\('MISMATCH #' + \\(i + 1\\) + ':'\\);\n        console.log\\('  Lead Name:        ' + m.leadName\\);\n        console.log\\('  Lead Email:       ' + m.leadEmail\\);\n        console.log\\('  Lead ID:          ' + m.leadId\\);\n        console.log\\('  Current Booker:   ' + m.currentBookerName + ' \\(' + m.currentBookerId + '\\)'\\);\n        console.log\\('  Original Booker:  ' + m.originalBookerName + ' \\(' + m.originalBookerId + '\\)'\\);\n        console.log\\('  History Entries:   ' + m.historyLength\\);\n        console.log\\('  First Entry:      ' + JSON.stringify\\(m.firstHistoryEntry\\)\\);\n        console.log\\('  Full booking_history user trail:'\\);\n        for \\(const entry of m.allHistory\\) {\n          const uid = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          const action = entry.action || entry.type || 'N/A';\n          const timestamp = entry.timestamp || entry.date || entry.created_at || 'N/A';\n          const userName = uid ? \\(\\(usersMap[uid] && usersMap[uid].name\\) || 'UNKNOWN'\\) : 'no-user';\n          if \\(uid\\) { console.log\\('    -> [' + timestamp + '] ' + action + ' by ' + userName + ' \\(' + uid + '\\)'\\); }\n        }\n        console.log\\('  SHOULD FIX: YES - restore booker_id to ' + m.originalBookerName\\);\n      }\n    }\n    \n    if \\(mismatches.length > 0\\) {\n      console.log\\(''\\);\n      console.log\\('='.repeat\\(80\\)\\);\n      console.log\\('STEP 4: FIXING MISMATCHES'\\);\n      console.log\\('='.repeat\\(80\\)\\);\n      let fixCount = 0;\n      for \\(const m of mismatches\\) {\n        if \\(m.leadId === sophieLeadId\\) { console.log\\('  [SKIP] ' + m.leadName + ' - already fixed in Step 1'\\); continue; }\n        console.log\\('  Fixing ' + m.leadName + ' \\(' + m.leadId + '\\)...'\\);\n        console.log\\('    ' + m.currentBookerName + ' -> ' + m.originalBookerName\\);\n        await client.query\\('UPDATE leads SET booker_id = `$1 WHERE id = `$2', [m.originalBookerId, m.leadId]\\);\n        fixCount++;\n        console.log\\('    DONE'\\);\n      }\n      console.log\\('  Fixed ' + fixCount + ' additional leads.'\\);\n    }\n    \n    console.log\\(''\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('SUMMARY'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('  Sophie Hume: FIXED \\(booker restored to Amy Booker\\)'\\);\n    console.log\\('  Other mismatches found: ' + mismatches.length\\);\n    console.log\\('  Total leads checked: ' + checkedCount\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    \n  } catch \\(err\\) {\n    console.error\\('ERROR:', err\\);\n  } finally {\n    client.release\\(\\);\n    await pool.end\\(\\);\n  }\n}\n\nrun\\(\\);\n\"@\n\n[System.IO.File]::WriteAllText\\(\"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\fix_booker_overwrite.js\", $script\\)\nWrite-Host \"Script written successfully\"\nPSEOF)",
      "Bash(powershell.exe -NoProfile -Command \"Set-Content -Path ''C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\fix_booker_overwrite.js'' -Value \\(\n[System.Text.Encoding]::UTF8.GetString\\([System.Convert]::FromBase64String\\(\n''cmVxdWlyZSgiZG90ZW52IikuY29uZmlnKCk7DQpjb25zdCB7IFBvb2wgfSA9IHJlcXVpcmUoInBnIik7DQoNCmNvbnN0IHBvb2wgPSBuZXcgUG9vbCh7DQogIGNvbm5lY3Rpb25TdHJpbmc6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCwNCiAgc3NsOiB7IHJlamVjdFVuYXV0aG9yaXplZDogZmFsc2UgfQ0KfSk7DQoNCmFzeW5jIGZ1bmN0aW9uIHJ1bigpIHsNCiAgY29uc3QgY2xpZW50ID0gYXdhaXQgcG9vbC5jb25uZWN0KCk7DQogIHRyeSB7DQogICAgY29uc29sZS5sb2coIj0iLnJlcGVhdCg4MCkpOw0KICAgIGNvbnNvbGUubG9nKCJTVEVQIDEgZG9uZSIpOw0KICB9IGNhdGNoIChlcnIpIHsNCiAgICBjb25zb2xlLmVycm9yKGVycik7DQogIH0gZmluYWxseSB7DQogICAgY2xpZW50LnJlbGVhc2UoKTsNCiAgICBhd2FpdCBwb29sLmVuZCgpOw0KICB9DQp9DQpydW4oKTs=''\n\\)\\)\\); Write-Host ''Done''\")",
      "Bash(python \"/c/Users/Tin/CRM -Alan/server/_writer.py\" << 'ENDSCRIPT'\nrequire\\(\"dotenv\"\\).config\\(\\);\nconst { createClient } = require\\(\"@supabase/supabase-js\"\\);\nconst supabase = createClient\\(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY\\);\n\nasync function run\\(\\) {\n  try {\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"STEP 1: Fix Sophie Hume\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n\n    const sophieLeadId = \"8e465a93-4f22-4878-aab8-fd2615dfe2ff\";\n    const amyBookerId = \"f038e141-203b-4d37-b641-88ac9bd58627\";\n\n    const { data: sophieBefore, error: sErr1 } = await supabase\n      .from\\(\"leads\"\\)\n      .select\\(\"id, name, email, booker_id, booking_history\"\\)\n      .eq\\(\"id\", sophieLeadId\\)\n      .single\\(\\);\n\n    if \\(sErr1 || !sophieBefore\\) {\n      console.log\\(\"WARNING: Sophie Hume lead not found!\", sErr1\\);\n    } else {\n      const { data: currentBooker } = await supabase\n        .from\\(\"users\"\\).select\\(\"name\"\\).eq\\(\"id\", sophieBefore.booker_id\\).single\\(\\);\n\n      console.log\\(\"  Lead: \" + sophieBefore.name + \" \\(\" + sophieBefore.email + \"\\)\"\\);\n      console.log\\(\"  Current booker_id: \" + sophieBefore.booker_id\\);\n      console.log\\(\"  Current booker name: \" + \\(currentBooker ? currentBooker.name : \"UNKNOWN\"\\)\\);\n\n      const { error: updateErr } = await supabase\n        .from\\(\"leads\"\\).update\\({ booker_id: amyBookerId }\\).eq\\(\"id\", sophieLeadId\\);\n\n      if \\(updateErr\\) {\n        console.log\\(\"  ERROR updating Sophie:\", updateErr\\);\n      } else {\n        const { data: sophieAfter } = await supabase.from\\(\"leads\"\\).select\\(\"booker_id\"\\).eq\\(\"id\", sophieLeadId\\).single\\(\\);\n        const { data: newBooker } = await supabase.from\\(\"users\"\\).select\\(\"name\"\\).eq\\(\"id\", sophieAfter.booker_id\\).single\\(\\);\n        console.log\\(\"  FIXED -> booker_id now: \" + sophieAfter.booker_id\\);\n        console.log\\(\"  FIXED -> booker name: \" + \\(newBooker ? newBooker.name : \"UNKNOWN\"\\)\\);\n      }\n    }\n\n    console.log\\(\"\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"STEP 2: Scanning ALL Booked leads for booker_id overwrites\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n\n    const { data: users } = await supabase.from\\(\"users\"\\).select\\(\"id, name, email\"\\);\n    const usersMap = {};\n    for \\(const u of users\\) { usersMap[u.id] = u; }\n\n    let allLeads = [];\n    let from = 0;\n    const pageSize = 1000;\n    while \\(true\\) {\n      const { data: batch, error: bErr } = await supabase\n        .from\\(\"leads\"\\)\n        .select\\(\"id, name, email, phone, booker_id, booking_history, status\"\\)\n        .eq\\(\"status\", \"Booked\"\\)\n        .not\\(\"booking_history\", \"is\", null\\)\n        .not\\(\"booker_id\", \"is\", null\\)\n        .order\\(\"name\"\\)\n        .range\\(from, from + pageSize - 1\\);\n\n      if \\(bErr\\) { console.log\\(\"Query error:\", bErr\\); break; }\n      if \\(!batch || batch.length === 0\\) break;\n      allLeads = allLeads.concat\\(batch\\);\n      if \\(batch.length < pageSize\\) break;\n      from += pageSize;\n    }\n\n    console.log\\(\"Found \" + allLeads.length + \" Booked leads with booking_history to check.\"\\);\n\n    const mismatches = [];\n    let checkedCount = 0;\n\n    for \\(const lead of allLeads\\) {\n      checkedCount++;\n      let history;\n      try {\n        history = typeof lead.booking_history === \"string\" ? JSON.parse\\(lead.booking_history\\) : lead.booking_history;\n      } catch \\(e\\) { continue; }\n      if \\(!Array.isArray\\(history\\) || history.length === 0\\) continue;\n\n      let originalBooker = null;\n      let originalEntry = null;\n\n      for \\(const entry of history\\) {\n        const action = \\(entry.action || entry.type || \"\"\\).toUpperCase\\(\\);\n        const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n        if \\(userId && \\(action.includes\\(\"EMAIL\"\\) || action.includes\\(\"BOOK\"\\) || action.includes\\(\"CONFIRM\"\\) || action.includes\\(\"ASSIGN\"\\) || action.includes\\(\"STATUS\"\\)\\)\\) {\n          originalBooker = userId;\n          originalEntry = entry;\n          break;\n        }\n      }\n\n      if \\(!originalBooker\\) {\n        for \\(const entry of history\\) {\n          const userId = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          if \\(userId\\) { originalBooker = userId; originalEntry = entry; break; }\n        }\n      }\n\n      if \\(!originalBooker\\) continue;\n\n      if \\(originalBooker !== lead.booker_id\\) {\n        const originalUser = usersMap[originalBooker] || { name: \"UNKNOWN\", email: \"unknown\" };\n        const currentUser = usersMap[lead.booker_id] || { name: \"UNKNOWN\", email: \"unknown\" };\n        mismatches.push\\({\n          leadId: lead.id, leadName: lead.name, leadEmail: lead.email,\n          currentBookerId: lead.booker_id, currentBookerName: currentUser.name || \"UNKNOWN\",\n          originalBookerId: originalBooker, originalBookerName: originalUser.name || \"UNKNOWN\",\n          firstHistoryEntry: originalEntry, historyLength: history.length, allHistory: history\n        }\\);\n      }\n    }\n\n    console.log\\(\"\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"STEP 3: MISMATCH REPORT\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"Checked \" + checkedCount + \" Booked leads.\"\\);\n    console.log\\(\"Found \" + mismatches.length + \" leads with booker_id mismatches.\"\\);\n    console.log\\(\"\"\\);\n\n    if \\(mismatches.length === 0\\) {\n      console.log\\(\"No mismatches found besides Sophie Hume \\(already fixed\\).\"\\);\n    } else {\n      for \\(let i = 0; i < mismatches.length; i++\\) {\n        const m = mismatches[i];\n        console.log\\(\"-\".repeat\\(70\\)\\);\n        console.log\\(\"MISMATCH #\" + \\(i + 1\\) + \":\"\\);\n        console.log\\(\"  Lead Name:        \" + m.leadName\\);\n        console.log\\(\"  Lead Email:       \" + m.leadEmail\\);\n        console.log\\(\"  Lead ID:          \" + m.leadId\\);\n        console.log\\(\"  Current Booker:   \" + m.currentBookerName + \" \\(\" + m.currentBookerId + \"\\)\"\\);\n        console.log\\(\"  Original Booker:  \" + m.originalBookerName + \" \\(\" + m.originalBookerId + \"\\)\"\\);\n        console.log\\(\"  History Entries:   \" + m.historyLength\\);\n        console.log\\(\"  First Entry:      \" + JSON.stringify\\(m.firstHistoryEntry\\)\\);\n        console.log\\(\"  Full booking_history user trail:\"\\);\n        for \\(const entry of m.allHistory\\) {\n          const uid = entry.user_id || entry.userId || entry.booker_id || entry.bookerId;\n          const action = entry.action || entry.type || \"N/A\";\n          const timestamp = entry.timestamp || entry.date || entry.created_at || \"N/A\";\n          const userName = uid ? \\(\\(usersMap[uid] && usersMap[uid].name\\) || \"UNKNOWN\"\\) : \"no-user\";\n          if \\(uid\\) { console.log\\(\"    -> [\" + timestamp + \"] \" + action + \" by \" + userName + \" \\(\" + uid + \"\\)\"\\); }\n        }\n        console.log\\(\"  SHOULD FIX: YES - restore booker_id to \" + m.originalBookerName\\);\n      }\n    }\n\n    if \\(mismatches.length > 0\\) {\n      console.log\\(\"\"\\);\n      console.log\\(\"=\".repeat\\(80\\)\\);\n      console.log\\(\"STEP 4: FIXING MISMATCHES\"\\);\n      console.log\\(\"=\".repeat\\(80\\)\\);\n      let fixCount = 0;\n      for \\(const m of mismatches\\) {\n        if \\(m.leadId === sophieLeadId\\) {\n          console.log\\(\"  [SKIP] \" + m.leadName + \" - already fixed in Step 1\"\\);\n          continue;\n        }\n        console.log\\(\"  Fixing \" + m.leadName + \" \\(\" + m.leadId + \"\\)...\"\\);\n        console.log\\(\"    \" + m.currentBookerName + \" -> \" + m.originalBookerName\\);\n        const { error: fixErr } = await supabase\n          .from\\(\"leads\"\\).update\\({ booker_id: m.originalBookerId }\\).eq\\(\"id\", m.leadId\\);\n        if \\(fixErr\\) {\n          console.log\\(\"    ERROR: \" + fixErr.message\\);\n        } else {\n          fixCount++;\n          console.log\\(\"    DONE\"\\);\n        }\n      }\n      console.log\\(\"  Fixed \" + fixCount + \" additional leads.\"\\);\n    }\n\n    console.log\\(\"\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"SUMMARY\"\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n    console.log\\(\"  Sophie Hume: FIXED \\(booker restored to Amy Booker\\)\"\\);\n    console.log\\(\"  Other mismatches found: \" + mismatches.length\\);\n    console.log\\(\"  Total leads checked: \" + checkedCount\\);\n    console.log\\(\"=\".repeat\\(80\\)\\);\n\n  } catch \\(err\\) {\n    console.error\\(\"ERROR:\", err\\);\n  }\n}\n\nrun\\(\\);\nENDSCRIPT)",
      "Bash(\"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\audit_and_fix_bookers.js\" << 'ENDOFSCRIPT'\nrequire\\('dotenv'\\).config\\(\\);\nconst { Pool } = require\\('pg'\\);\n\nconst pool = new Pool\\({\n  connectionString: process.env.DATABASE_URL,\n  ssl: { rejectUnauthorized: false }\n}\\);\n\nconst AMBER_ID = '3cee4210-81e9-40e7-97ae-58f6209e347c';\nconst MICHAEL_ID = '1b8645fa-7a43-487f-9efb-dca55d1a7ea1';\nconst RACHEL_LEAD_ID = '18df4617-98ab-4629-9055-a8d16598c1ae';\nconst JAISAL_LEAD_ID = 'dd98a957-4e20-4771-8618-f2701639a374';\n\nasync function run\\(\\) {\n  const client = await pool.connect\\(\\);\n  try {\n    // Build a user lookup map\n    const usersRes = await client.query\\('SELECT id, name, email FROM users'\\);\n    const userMap = {};\n    for \\(const u of usersRes.rows\\) {\n      userMap[u.id] = u.name || u.email || u.id;\n    }\n    const userName = \\(id\\) => userMap[id] || id || 'UNKNOWN';\n\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('TASK 1: Fix Rachel Hughes - Change booker_id from Amy to Michael'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n\n    const rachelBefore = await client.query\\(\n      'SELECT id, name, email, status, booker_id FROM leads WHERE id = $1', [RACHEL_LEAD_ID]\n    \\);\n    if \\(rachelBefore.rows.length === 0\\) {\n      console.log\\('ERROR: Rachel Hughes lead not found!'\\);\n    } else {\n      const r = rachelBefore.rows[0];\n      console.log\\('\\\\nBEFORE:'\\);\n      console.log\\('  Name: ' + r.name\\);\n      console.log\\('  Email: ' + r.email\\);\n      console.log\\('  Status: ' + r.status\\);\n      console.log\\('  Current booker_id: ' + r.booker_id + ' \\(' + userName\\(r.booker_id\\) + '\\)'\\);\n\n      await client.query\\('UPDATE leads SET booker_id = $1 WHERE id = $2', [MICHAEL_ID, RACHEL_LEAD_ID]\\);\n\n      const rachelAfter = await client.query\\(\n        'SELECT id, name, email, status, booker_id FROM leads WHERE id = $1', [RACHEL_LEAD_ID]\n      \\);\n      const ra = rachelAfter.rows[0];\n      console.log\\('\\\\nAFTER:'\\);\n      console.log\\('  booker_id: ' + ra.booker_id + ' \\(' + userName\\(ra.booker_id\\) + '\\)'\\);\n      console.log\\('  FIXED SUCCESSFULLY'\\);\n    }\n\n    console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n    console.log\\('TASK 2: Re-check Jaisal Pastakia - Find original booker'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n\n    const jaisalRes = await client.query\\(\n      'SELECT id, name, email, status, booker_id, created_by_user_id, booking_history FROM leads WHERE id = $1',\n      [JAISAL_LEAD_ID]\n    \\);\n    if \\(jaisalRes.rows.length === 0\\) {\n      console.log\\('ERROR: Jaisal Pastakia lead not found!'\\);\n    } else {\n      const j = jaisalRes.rows[0];\n      console.log\\('\\\\nLead: ' + j.name + ' \\(' + j.email + '\\)'\\);\n      console.log\\('Status: ' + j.status\\);\n      console.log\\('Current booker_id: ' + j.booker_id + ' \\(' + userName\\(j.booker_id\\) + '\\)'\\);\n      console.log\\('created_by_user_id: ' + j.created_by_user_id + ' \\(' + userName\\(j.created_by_user_id\\) + '\\)'\\);\n\n      let history = j.booking_history;\n      if \\(typeof history === 'string'\\) {\n        try { history = JSON.parse\\(history\\); } catch\\(e\\) { history = []; }\n      }\n      if \\(!Array.isArray\\(history\\)\\) history = [];\n\n      console.log\\('\\\\nFULL booking_history \\(' + history.length + ' entries\\):'\\);\n      for \\(let i = 0; i < history.length; i++\\) {\n        const h = history[i];\n        const ts = h.timestamp || h.date || h.created_at || '';\n        const type = h.type || h.action || '';\n        const by = h.user_id || h.userId || h.performed_by || h.assignedBy || '';\n        const details = h.details || h.note || h.notes || '';\n        const assignedTo = h.assigned_to || h.assignedTo || '';\n        const detailStr = typeof details === 'string' ? details.substring\\(0, 120\\) : JSON.stringify\\(details\\).substring\\(0, 120\\);\n        console.log\\('  [' + i + '] ' + ts + ' | ' + type + ' | by: ' + userName\\(by\\) + ' \\(' + by + '\\) | to: ' + \\(assignedTo ? userName\\(assignedTo\\) + ' \\(' + assignedTo + '\\)' : 'N/A'\\) + ' | ' + detailStr\\);\n      }\n\n      // Find first interaction\n      const firstInteraction = history.find\\(h => {\n        const type = \\(h.type || h.action || ''\\).toUpperCase\\(\\);\n        return type.includes\\('EMAIL'\\) || type.includes\\('SMS'\\) || type.includes\\('CALL'\\) || type.includes\\('BOOK'\\);\n      }\\);\n\n      const assignments = history.filter\\(h => {\n        const type = \\(h.type || h.action || ''\\).toUpperCase\\(\\);\n        return type.includes\\('ASSIGN'\\) || type.includes\\('BULK'\\);\n      }\\);\n\n      console.log\\('\\\\nAnalysis:'\\);\n      if \\(firstInteraction\\) {\n        const by = firstInteraction.user_id || firstInteraction.userId || firstInteraction.performed_by || '';\n        console.log\\('  First interaction: ' + \\(firstInteraction.type || firstInteraction.action\\) + ' by ' + userName\\(by\\) + ' \\(' + by + '\\)'\\);\n      }\n      if \\(assignments.length > 0\\) {\n        console.log\\('  Assignments found: ' + assignments.length\\);\n        for \\(const a of assignments\\) {\n          const by = a.user_id || a.userId || a.performed_by || a.assignedBy || '';\n          const to = a.assigned_to || a.assignedTo || '';\n          console.log\\('    ' + \\(a.type || a.action\\) + ': by ' + userName\\(by\\) + ' -> to ' + userName\\(to\\) + ' \\(' + to + '\\)'\\);\n        }\n      }\n\n      let originalBooker = null;\n      if \\(assignments.length > 0\\) {\n        const firstAssign = assignments[0];\n        const assignedTo = firstAssign.assigned_to || firstAssign.assignedTo || '';\n        if \\(assignedTo && assignedTo !== AMBER_ID\\) {\n          originalBooker = assignedTo;\n          console.log\\('\\\\n  MISMATCH: First assigned to ' + userName\\(assignedTo\\) + ' but current booker is Amber'\\);\n        }\n      }\n      if \\(!originalBooker && firstInteraction\\) {\n        const by = firstInteraction.user_id || firstInteraction.userId || firstInteraction.performed_by || '';\n        if \\(by && by !== AMBER_ID\\) {\n          originalBooker = by;\n          console.log\\('\\\\n  MISMATCH: First interaction by ' + userName\\(by\\) + ' but current booker is Amber'\\);\n        }\n      }\n      if \\(!originalBooker && j.created_by_user_id && j.created_by_user_id !== AMBER_ID\\) {\n        originalBooker = j.created_by_user_id;\n        console.log\\('\\\\n  MISMATCH: created_by_user_id is ' + userName\\(j.created_by_user_id\\) + ' but current booker is Amber'\\);\n      }\n\n      if \\(originalBooker\\) {\n        console.log\\('\\\\n  Fixing Jaisal: booker_id -> ' + userName\\(originalBooker\\) + ' \\(' + originalBooker + '\\)'\\);\n        await client.query\\('UPDATE leads SET booker_id = $1 WHERE id = $2', [originalBooker, JAISAL_LEAD_ID]\\);\n        const verify = await client.query\\('SELECT booker_id FROM leads WHERE id = $1', [JAISAL_LEAD_ID]\\);\n        console.log\\('  Verified: booker_id is now ' + verify.rows[0].booker_id + ' \\(' + userName\\(verify.rows[0].booker_id\\) + '\\)'\\);\n      } else {\n        console.log\\('\\\\n  No mismatch found - Amber appears to be the correct booker.'\\);\n      }\n    }\n\n    console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n    console.log\\('TASK 3: Audit ALL leads where Amber is current booker_id'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n\n    const amberLeads = await client.query\\(\n      'SELECT id, name, email, status, booker_id, created_by_user_id, booking_history FROM leads WHERE booker_id = $1',\n      [AMBER_ID]\n    \\);\n\n    console.log\\('\\\\nFound ' + amberLeads.rows.length + ' leads with Amber as booker_id\\\\n'\\);\n\n    const mismatches = [];\n\n    for \\(const lead of amberLeads.rows\\) {\n      let history = lead.booking_history;\n      if \\(typeof history === 'string'\\) {\n        try { history = JSON.parse\\(history\\); } catch\\(e\\) { history = []; }\n      }\n      if \\(!Array.isArray\\(history\\)\\) history = [];\n\n      const issues = [];\n      let suggestedBooker = null;\n\n      // a\\) First EMAIL_SENT or SMS_SENT\n      const firstComms = history.find\\(h => {\n        const type = \\(h.type || h.action || ''\\).toUpperCase\\(\\);\n        return type.includes\\('EMAIL_SENT'\\) || type.includes\\('SMS_SENT'\\);\n      }\\);\n      if \\(firstComms\\) {\n        const by = firstComms.user_id || firstComms.userId || firstComms.performed_by || '';\n        if \\(by && by !== AMBER_ID\\) {\n          issues.push\\('First comms \\(' + \\(firstComms.type || firstComms.action\\) + '\\) by ' + userName\\(by\\) + ' \\(' + by + '\\)'\\);\n          if \\(!suggestedBooker\\) suggestedBooker = by;\n        }\n      }\n\n      // b\\) ASSIGNMENT or BULK_ASSIGN entries\n      const assignments = history.filter\\(h => {\n        const type = \\(h.type || h.action || ''\\).toUpperCase\\(\\);\n        return type.includes\\('ASSIGN'\\) || type.includes\\('BULK'\\);\n      }\\);\n      if \\(assignments.length > 0\\) {\n        const firstAssign = assignments[0];\n        const assignedTo = firstAssign.assigned_to || firstAssign.assignedTo || '';\n        const assignedBy = firstAssign.user_id || firstAssign.userId || firstAssign.performed_by || firstAssign.assignedBy || '';\n        if \\(assignedTo && assignedTo !== AMBER_ID\\) {\n          issues.push\\('First assigned to ' + userName\\(assignedTo\\) + ' \\(' + assignedTo + '\\) by ' + userName\\(assignedBy\\)\\);\n          if \\(!suggestedBooker\\) suggestedBooker = assignedTo;\n        }\n      }\n\n      // c\\) First booking confirmation\n      const firstBooking = history.find\\(h => {\n        const type = \\(h.type || h.action || ''\\).toUpperCase\\(\\);\n        return \\(type.includes\\('BOOK'\\) || type.includes\\('CONFIRM'\\) || type.includes\\('STATUS_CHANGE'\\)\\) &&\n               \\(!type.includes\\('BULK_ASSIGN'\\)\\);\n      }\\);\n      if \\(firstBooking\\) {\n        const by = firstBooking.user_id || firstBooking.userId || firstBooking.performed_by || '';\n        if \\(by && by !== AMBER_ID\\) {\n          issues.push\\('First booking/status \\(' + \\(firstBooking.type || firstBooking.action\\) + '\\) by ' + userName\\(by\\) + ' \\(' + by + '\\)'\\);\n          if \\(!suggestedBooker\\) suggestedBooker = by;\n        }\n      }\n\n      // Check created_by_user_id\n      if \\(lead.created_by_user_id && lead.created_by_user_id !== AMBER_ID\\) {\n        issues.push\\('created_by_user_id: ' + userName\\(lead.created_by_user_id\\) + ' \\(' + lead.created_by_user_id + '\\)'\\);\n        if \\(!suggestedBooker\\) suggestedBooker = lead.created_by_user_id;\n      }\n\n      if \\(issues.length > 0 && suggestedBooker\\) {\n        mismatches.push\\({\n          id: lead.id,\n          name: lead.name,\n          email: lead.email,\n          status: lead.status,\n          issues,\n          suggestedBooker,\n          suggestedBookerName: userName\\(suggestedBooker\\),\n          historyCount: history.length\n        }\\);\n      }\n    }\n\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('MISMATCHES FOUND: ' + mismatches.length + ' out of ' + amberLeads.rows.length + ' Amber leads'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n\n    for \\(const m of mismatches\\) {\n      console.log\\('\\\\n  Lead: ' + m.name + ' \\(' + m.email + '\\)'\\);\n      console.log\\('  ID: ' + m.id\\);\n      console.log\\('  Status: ' + m.status\\);\n      console.log\\('  History entries: ' + m.historyCount\\);\n      console.log\\('  Original booker should be: ' + m.suggestedBookerName + ' \\(' + m.suggestedBooker + '\\)'\\);\n      console.log\\('  Evidence:'\\);\n      for \\(const issue of m.issues\\) {\n        console.log\\('    - ' + issue\\);\n      }\n      console.log\\('  NEEDS FIXING: YES'\\);\n    }\n\n    // Fix all mismatches\n    if \\(mismatches.length > 0\\) {\n      console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n      console.log\\('FIXING ALL MISMATCHES...'\\);\n      console.log\\('='.repeat\\(80\\)\\);\n\n      for \\(const m of mismatches\\) {\n        await client.query\\('UPDATE leads SET booker_id = $1 WHERE id = $2', [m.suggestedBooker, m.id]\\);\n        console.log\\('  Fixed: ' + m.name + ' -> booker_id = ' + m.suggestedBookerName + ' \\(' + m.suggestedBooker + '\\)'\\);\n      }\n\n      console.log\\('\\\\nVerifying all fixes...'\\);\n      for \\(const m of mismatches\\) {\n        const verify = await client.query\\('SELECT booker_id FROM leads WHERE id = $1', [m.id]\\);\n        const newBooker = verify.rows[0].booker_id;\n        const ok = newBooker === m.suggestedBooker;\n        console.log\\('  ' + m.name + ': booker_id = ' + userName\\(newBooker\\) + ' ' + \\(ok ? 'VERIFIED' : 'FAILED!'\\)\\);\n      }\n    }\n\n    // Final summary\n    console.log\\('\\\\n' + '='.repeat\\(80\\)\\);\n    console.log\\('FINAL SUMMARY'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('\\\\nTask 1: Rachel Hughes -> booker_id changed to Michael - DONE'\\);\n    console.log\\('Task 2: Jaisal Pastakia -> investigated and handled'\\);\n    console.log\\('Task 3: Audited ' + amberLeads.rows.length + ' Amber leads, found ' + mismatches.length + ' mismatches, all fixed.'\\);\n\n    // Breakdown by who the leads were reassigned to\n    const reassignedTo = {};\n    for \\(const m of mismatches\\) {\n      const name = m.suggestedBookerName;\n      if \\(!reassignedTo[name]\\) reassignedTo[name] = [];\n      reassignedTo[name].push\\(m.name\\);\n    }\n    console.log\\('\\\\nReassignment breakdown:'\\);\n    for \\(const [name, leads] of Object.entries\\(reassignedTo\\)\\) {\n      console.log\\('  ' + name + ': ' + leads.length + ' leads'\\);\n      for \\(const l of leads\\) {\n        console.log\\('    - ' + l\\);\n      }\n    }\n\n  } catch\\(err\\) {\n    console.error\\('ERROR:', err\\);\n  } finally {\n    client.release\\(\\);\n    await pool.end\\(\\);\n  }\n}\n\nrun\\(\\);\nENDOFSCRIPT)",
      "Bash(powershell.exe -NoProfile -Command \"Set-Content -Path ''C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\audit_and_fix_bookers.js'' -Value \\(Get-Content -Raw -Path ''NUL''\\) -Force; Write-Host ''cleared''\")",
      "Bash(python \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\_writer.py\" << 'JSEOF'\nrequire\\('dotenv'\\).config\\(\\);\nconst { Pool } = require\\('pg'\\);\nconst pool = new Pool\\({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } }\\);\n\nconst AMBER_ID = '3cee4210-81e9-40e7-97ae-58f6209e347c';\nconst MICHAEL_ID = '1b8645fa-7a43-487f-9efb-dca55d1a7ea1';\nconst RACHEL_LEAD_ID = '18df4617-98ab-4629-9055-a8d16598c1ae';\nconst JAISAL_LEAD_ID = 'dd98a957-4e20-4771-8618-f2701639a374';\n\nasync function run\\(\\) {\n  const client = await pool.connect\\(\\);\n  try {\n    const usersRes = await client.query\\('SELECT id, name, email FROM users'\\);\n    const userMap = {};\n    for \\(const u of usersRes.rows\\) userMap[u.id] = u.name || u.email || u.id;\n    const userName = \\(id\\) => userMap[id] || id || 'UNKNOWN';\n\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('TASK 1: Fix Rachel Hughes - Change booker_id from Amy to Michael'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    const rb = await client.query\\('SELECT id,name,email,status,booker_id FROM leads WHERE id=$1',[RACHEL_LEAD_ID]\\);\n    if\\(rb.rows.length===0\\){console.log\\('NOT FOUND'\\);}else{\n      const r=rb.rows[0];\n      console.log\\('BEFORE:', 'Name:', r.name, 'Email:', r.email, 'Status:', r.status, 'booker:', r.booker_id, '\\('+userName\\(r.booker_id\\)+'\\)'\\);\n      await client.query\\('UPDATE leads SET booker_id=$1 WHERE id=$2',[MICHAEL_ID,RACHEL_LEAD_ID]\\);\n      const ra=await client.query\\('SELECT booker_id FROM leads WHERE id=$1',[RACHEL_LEAD_ID]\\);\n      console.log\\('AFTER: booker_id:', ra.rows[0].booker_id, '\\('+userName\\(ra.rows[0].booker_id\\)+'\\) FIXED'\\);\n    }\n\n    console.log\\('\\\\n'+'='.repeat\\(80\\)\\);\n    console.log\\('TASK 2: Re-check Jaisal Pastakia'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    const jr=await client.query\\('SELECT id,name,email,status,booker_id,created_by_user_id,booking_history FROM leads WHERE id=$1',[JAISAL_LEAD_ID]\\);\n    if\\(jr.rows.length===0\\){console.log\\('NOT FOUND'\\);}else{\n      const j=jr.rows[0];\n      console.log\\('Lead:', j.name, '\\('+j.email+'\\)'\\);\n      console.log\\('Status:', j.status\\);\n      console.log\\('Current booker_id:', j.booker_id, '\\('+userName\\(j.booker_id\\)+'\\)'\\);\n      console.log\\('created_by_user_id:', j.created_by_user_id, '\\('+userName\\(j.created_by_user_id\\)+'\\)'\\);\n      let hist=j.booking_history;\n      if\\(typeof hist==='string'\\)try{hist=JSON.parse\\(hist\\);}catch\\(e\\){hist=[];}\n      if\\(!Array.isArray\\(hist\\)\\)hist=[];\n      console.log\\('\\\\nFULL booking_history \\('+hist.length+' entries\\):'\\);\n      for\\(let i=0;i<hist.length;i++\\){\n        const h=hist[i]; const ts=h.timestamp||h.date||h.created_at||''; const tp=h.type||h.action||'';\n        const by=h.user_id||h.userId||h.performed_by||h.assignedBy||'';\n        const det=h.details||h.note||h.notes||''; const ato=h.assigned_to||h.assignedTo||'';\n        const ds=typeof det==='string'?det.substring\\(0,120\\):JSON.stringify\\(det\\).substring\\(0,120\\);\n        console.log\\(' ['+i+']', ts, '|', tp, '| by:', userName\\(by\\), '\\('+by+'\\) | to:', \\(ato?userName\\(ato\\)+' \\('+ato+'\\)':'N/A'\\), '|', ds\\);\n      }\n      const fi=hist.find\\(h=>{const t=\\(h.type||h.action||''\\).toUpperCase\\(\\);return t.includes\\('EMAIL'\\)||t.includes\\('SMS'\\)||t.includes\\('CALL'\\)||t.includes\\('BOOK'\\);}\\);\n      const asgns=hist.filter\\(h=>{const t=\\(h.type||h.action||''\\).toUpperCase\\(\\);return t.includes\\('ASSIGN'\\)||t.includes\\('BULK'\\);}\\);\n      console.log\\('\\\\nAnalysis:'\\);\n      if\\(fi\\){const by=fi.user_id||fi.userId||fi.performed_by||'';console.log\\('  First interaction:',\\(fi.type||fi.action\\),'by',userName\\(by\\),'\\('+by+'\\)'\\);}\n      if\\(asgns.length>0\\){console.log\\('  Assignments:',asgns.length\\);for\\(const a of asgns\\){const by=a.user_id||a.userId||a.performed_by||a.assignedBy||'';const to=a.assigned_to||a.assignedTo||'';console.log\\('   ',\\(a.type||a.action\\)+':','by',userName\\(by\\),'-> to',userName\\(to\\),'\\('+to+'\\)'\\);}}\n      let ob=null;\n      if\\(asgns.length>0\\){const fa=asgns[0];const ato=fa.assigned_to||fa.assignedTo||'';if\\(ato&&ato!==AMBER_ID\\){ob=ato;console.log\\('\\\\n  MISMATCH: First assigned to',userName\\(ato\\),'but current booker is Amber'\\);}}\n      if\\(!ob&&fi\\){const by=fi.user_id||fi.userId||fi.performed_by||'';if\\(by&&by!==AMBER_ID\\){ob=by;console.log\\('\\\\n  MISMATCH: First interaction by',userName\\(by\\),'but current booker is Amber'\\);}}\n      if\\(!ob&&j.created_by_user_id&&j.created_by_user_id!==AMBER_ID\\){ob=j.created_by_user_id;console.log\\('\\\\n  MISMATCH: created_by is',userName\\(j.created_by_user_id\\),'not Amber'\\);}\n      if\\(ob\\){\n        console.log\\('\\\\n  Fixing Jaisal: booker_id ->',userName\\(ob\\),'\\('+ob+'\\)'\\);\n        await client.query\\('UPDATE leads SET booker_id=$1 WHERE id=$2',[ob,JAISAL_LEAD_ID]\\);\n        const v=await client.query\\('SELECT booker_id FROM leads WHERE id=$1',[JAISAL_LEAD_ID]\\);\n        console.log\\('  Verified:',v.rows[0].booker_id,'\\('+userName\\(v.rows[0].booker_id\\)+'\\)'\\);\n      }else{console.log\\('\\\\n  No mismatch - Amber appears correct.'\\);}\n    }\n\n    console.log\\('\\\\n'+'='.repeat\\(80\\)\\);\n    console.log\\('TASK 3: Audit ALL Amber leads'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    const al=await client.query\\('SELECT id,name,email,status,booker_id,created_by_user_id,booking_history FROM leads WHERE booker_id=$1',[AMBER_ID]\\);\n    console.log\\('\\\\nFound',al.rows.length,'leads with Amber as booker_id\\\\n'\\);\n    const mm=[];\n    for\\(const lead of al.rows\\){\n      let hist=lead.booking_history;\n      if\\(typeof hist==='string'\\)try{hist=JSON.parse\\(hist\\);}catch\\(e\\){hist=[];}\n      if\\(!Array.isArray\\(hist\\)\\)hist=[];\n      const issues=[];let sb=null;\n      const fc=hist.find\\(h=>{const t=\\(h.type||h.action||''\\).toUpperCase\\(\\);return t.includes\\('EMAIL_SENT'\\)||t.includes\\('SMS_SENT'\\);}\\);\n      if\\(fc\\){const by=fc.user_id||fc.userId||fc.performed_by||'';if\\(by&&by!==AMBER_ID\\){issues.push\\('First comms \\('+\\(fc.type||fc.action\\)+'\\) by '+userName\\(by\\)+' \\('+by+'\\)'\\);if\\(!sb\\)sb=by;}}\n      const asl=hist.filter\\(h=>{const t=\\(h.type||h.action||''\\).toUpperCase\\(\\);return t.includes\\('ASSIGN'\\)||t.includes\\('BULK'\\);}\\);\n      if\\(asl.length>0\\){const fa=asl[0];const ato=fa.assigned_to||fa.assignedTo||'';const aby=fa.user_id||fa.userId||fa.performed_by||fa.assignedBy||'';\n        if\\(ato&&ato!==AMBER_ID\\){issues.push\\('First assigned to '+userName\\(ato\\)+' \\('+ato+'\\) by '+userName\\(aby\\)\\);if\\(!sb\\)sb=ato;}}\n      const fb=hist.find\\(h=>{const t=\\(h.type||h.action||''\\).toUpperCase\\(\\);return\\(t.includes\\('BOOK'\\)||t.includes\\('CONFIRM'\\)||t.includes\\('STATUS_CHANGE'\\)\\)&&!t.includes\\('BULK_ASSIGN'\\);}\\);\n      if\\(fb\\){const by=fb.user_id||fb.userId||fb.performed_by||'';if\\(by&&by!==AMBER_ID\\){issues.push\\('First booking/status \\('+\\(fb.type||fb.action\\)+'\\) by '+userName\\(by\\)+' \\('+by+'\\)'\\);if\\(!sb\\)sb=by;}}\n      if\\(lead.created_by_user_id&&lead.created_by_user_id!==AMBER_ID\\){issues.push\\('created_by_user_id: '+userName\\(lead.created_by_user_id\\)+' \\('+lead.created_by_user_id+'\\)'\\);if\\(!sb\\)sb=lead.created_by_user_id;}\n      if\\(issues.length>0&&sb\\){mm.push\\({id:lead.id,name:lead.name,email:lead.email,status:lead.status,issues,suggestedBooker:sb,suggestedBookerName:userName\\(sb\\),historyCount:hist.length}\\);}\n    }\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('MISMATCHES:',mm.length,'out of',al.rows.length,'Amber leads'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    for\\(const m of mm\\){\n      console.log\\('\\\\n  Lead:',m.name,'\\('+m.email+'\\)'\\);\n      console.log\\('  ID:',m.id\\);\n      console.log\\('  Status:',m.status\\);\n      console.log\\('  History entries:',m.historyCount\\);\n      console.log\\('  Original booker should be:',m.suggestedBookerName,'\\('+m.suggestedBooker+'\\)'\\);\n      console.log\\('  Evidence:'\\);\n      for\\(const i of m.issues\\)console.log\\('    -',i\\);\n      console.log\\('  NEEDS FIXING: YES'\\);\n    }\n    if\\(mm.length>0\\){\n      console.log\\('\\\\n'+'='.repeat\\(80\\)\\);\n      console.log\\('FIXING ALL MISMATCHES...'\\);\n      console.log\\('='.repeat\\(80\\)\\);\n      for\\(const m of mm\\){\n        await client.query\\('UPDATE leads SET booker_id=$1 WHERE id=$2',[m.suggestedBooker,m.id]\\);\n        console.log\\('  Fixed:',m.name,'->',m.suggestedBookerName,'\\('+m.suggestedBooker+'\\)'\\);\n      }\n      console.log\\('\\\\nVerifying...'\\);\n      for\\(const m of mm\\){\n        const v=await client.query\\('SELECT booker_id FROM leads WHERE id=$1',[m.id]\\);\n        const nb=v.rows[0].booker_id;\n        console.log\\(' ',m.name+':',userName\\(nb\\),nb===m.suggestedBooker?'VERIFIED':'FAILED!'\\);\n      }\n    }\n    console.log\\('\\\\n'+'='.repeat\\(80\\)\\);\n    console.log\\('FINAL SUMMARY'\\);\n    console.log\\('='.repeat\\(80\\)\\);\n    console.log\\('\\\\nTask 1: Rachel Hughes -> Michael - DONE'\\);\n    console.log\\('Task 2: Jaisal Pastakia -> investigated and handled'\\);\n    console.log\\('Task 3: Audited',al.rows.length,'Amber leads, found',mm.length,'mismatches, all fixed.'\\);\n    const rt={};\n    for\\(const m of mm\\){if\\(!rt[m.suggestedBookerName]\\)rt[m.suggestedBookerName]=[];rt[m.suggestedBookerName].push\\(m.name\\);}\n    console.log\\('\\\\nReassignment breakdown:'\\);\n    for\\(const[n,ls]of Object.entries\\(rt\\)\\){console.log\\(' ',n+':',ls.length,'leads'\\);for\\(const l of ls\\)console.log\\('    -',l\\);}\n  }catch\\(err\\){console.error\\('ERROR:',err\\);}finally{client.release\\(\\);await pool.end\\(\\);}\n}\nrun\\(\\);\nJSEOF)",
      "Bash(powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\\\Users\\\\Tin\\\\CRM -Alan\\\\server\\\\write_audit_script.ps1\")",
      "Bash(powershell.exe:*)",
      "Bash(python -u:*)",
      "Bash(python _writer.py:*)",
      "Bash(where:*)",
      "Bash(/c/Python313/python:*)"
    ],
    "deny": [],
    "ask": []
  }
}
